# ON MASTER COMMIT:
# 1. BUILDS SELECTED VERSIONS OF PROD
# 2. PUBLISHES THOSE BUILDS TO GITHUB
# 3. GENERATES RELEASE NOTES
# 4. TAGS RELEASE IN GITHUB
# 5. SENDS OUT RELEASE EMAIL? (MAYBE)

pr: none
trigger: none
pool:
  vmImage: "ubuntu-latest"

parameters:
  - name: versionName
    displayName: "Version Number"
    type: string
    default: "4.0"
  - name: releaseType
    displayName: "Release Type"
    type: string
    default: "All"
    values:
      - "ReactNative"
      - "JetStream"
      - "Web"
      - "Both"
      - "All"
  - name: reactNativeAppKey
    displayName: "RN App Key"
    type: string
    default: ""
  - name: jetStreamAppKey
    displayName: "JetStream App Key"
    type: string
    default: ""

name: "RELEASE v${{ parameters.versionName }}"

stages:
  - stage: Build
    jobs:
      - job: Build_ReactNative
        condition: ${{ or(eq(parameters.releaseType, 'ReactNative'), eq(parameters.releaseType, 'Both'), eq(parameters.releaseType, 'All')) }}
        steps:
          - checkout: self
            persistCredentials: true

          - task: JavaToolInstaller@0
            inputs:
              versionSpec: "17"
              jdkArchitectureOption: "x64"
              jdkSourceOption: "PreInstalled"

          - script: |
              sed -i 's/"@hoppr\/react-native-hoppr": "[^"]*"/"@hoppr\/react-native-hoppr": "${{ parameters.versionName }}"/g' package.json
            displayName: "Update Hoppr version in package.json"
            workingDirectory: "$(System.DefaultWorkingDirectory)/ReactNativeSample"

          - script: |
              npm config list
              rm -rf android/.gradle android/app/build
              echo "HOPPR_APP_KEY=${{ parameters.reactNativeAppKey }}" > .env
              npm cache clean --force
              npm install
            displayName: "Clean and Install RN Dependencies"
            workingDirectory: "$(System.DefaultWorkingDirectory)/ReactNativeSample"

          - template: ./templates/bundleBuild.yml
            parameters:
              workingDirectory: "$(System.DefaultWorkingDirectory)/ReactNativeSample/android"
              gradleTask: "assembleRelease"
              publishPath: "$(System.DefaultWorkingDirectory)/ReactNativeSample/android/app/build/outputs/apk"
              publishName: "Hoppr-ReactNative-v${{ parameters.versionName }}"
              versionName: "${{ parameters.versionName }}"

      - job: Build_JetStream
        condition: ${{ or(eq(parameters.releaseType, 'JetStream'), eq(parameters.releaseType, 'Both'), eq(parameters.releaseType, 'All')) }}
        steps:
          - checkout: self
            persistCredentials: true

          - task: JavaToolInstaller@0
            inputs:
              versionSpec: "17"
              jdkArchitectureOption: "x64"
              jdkSourceOption: "PreInstalled"

          - script: |
              sed -i 's/^hoppr = ".*"/hoppr = "${{ parameters.versionName }}"/' gradle/libs.versions.toml
            displayName: "Update Hoppr version in libs.versions.toml"
            workingDirectory: "$(System.DefaultWorkingDirectory)/JetStreamCompose"

          - template: ./templates/bundleBuild.yml
            parameters:
              workingDirectory: "$(System.DefaultWorkingDirectory)/JetStreamCompose"
              gradleTask: "assembleRelease"
              publishPath: "$(System.DefaultWorkingDirectory)/JetStreamCompose/jetstream/build/outputs/apk"
              publishName: "Hoppr-JetStream-v${{ parameters.versionName }}"
              versionName: "${{ parameters.versionName }}"
              appKey: "${{ parameters.jetStreamAppKey }}"

      - job: Build_Web
        condition: ${{ or(eq(parameters.releaseType, 'Web'), eq(parameters.releaseType, 'All')) }}
        steps:
          - checkout: self
            persistCredentials: true

          - task: NodeTool@0
            displayName: "Install Node.js"
            inputs:
              versionSpec: "23.x"

          - task: DownloadSecureFile@1
            name: serviceAccountKey
            displayName: "Download GCP Service Account Key"
            inputs:
              secureFile: "$(SERVICE_KEY)"

          - script: |
              echo "Authenticating with GCP"
              gcloud auth activate-service-account --key-file=$(serviceAccountKey.secureFilePath)
              gcloud auth list
            displayName: "Authenticate with GCP"

          - script: |
              echo "Configuring npm for Google Artifact Registry"
              npm config set @hoppr:registry https://us-central1-npm.pkg.dev/hoppr-androidtv-dev/npm-repo/
              npm config set //us-central1-npm.pkg.dev/hoppr-androidtv-dev/npm-repo/:_authToken=$(gcloud auth print-access-token)
            displayName: "Configure npm for private registry"

          - script: |
              sed -i 's/"@hoppr\/hoppr-web-sdk": "[^"]*"/"@hoppr\/hoppr-web-sdk": "${{ parameters.versionName }}"/g' package.json
            displayName: "Update Hoppr version in package.json"
            workingDirectory: "$(System.DefaultWorkingDirectory)/Web"

          - script: |
              echo "HOPPR_SDK_VERSION=${{ parameters.versionName }}" > .env
            displayName: "Create .env file with version"
            workingDirectory: "$(System.DefaultWorkingDirectory)/Web"

          - script: |
              echo "Installing Firebase CLI"
              npm install -g firebase-tools@latest

              echo "Verifying Firebase CLI installation"
              firebase --version
            displayName: "Install Firebase CLI"

          - script: |
              echo "Installing Web app dependencies"
              npm install

              echo "Type checking Web application"
              npx tsc -b

              echo "Building Web application"
              npm run build:no-typecheck

              echo "Verifying build output"
              ls -la dist/
            workingDirectory: "$(System.DefaultWorkingDirectory)/Web"
            displayName: "Build Web Application"

          - script: |
              echo "Getting GCP access token for Firebase"
              FIREBASE_TOKEN=$(gcloud auth print-access-token)

              echo "Setting Firebase project"
              firebase use hoppr-androidtv-test --token "$FIREBASE_TOKEN"

              echo "Deploying to Firebase Hosting (site: hoppr-sdk-sample)"
              firebase deploy --only hosting:hoppr-sdk-sample --token "$FIREBASE_TOKEN" --non-interactive

              echo "Deployment completed successfully"
              echo "Web app deployed to: https://hoppr-sdk-sample.web.app"
            workingDirectory: "$(System.DefaultWorkingDirectory)/Web"
            displayName: "Deploy to Firebase Hosting"
